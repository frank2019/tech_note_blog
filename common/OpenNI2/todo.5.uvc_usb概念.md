



### 1，USB 是什么

- USB`（Universal Serial Bus） 是一种支持热插拔的高速串行传输总线，它使用 差分信号 来传输数据。
- 在 USB 1.0和 USB 1.1 版本中，只支持 1.5Mb/s 的低速（low-speed）模式和 12Mb/s 的全速（full-speed）模式，在 USB 2.0 中，又加入了480Mb/s 的高速模式，USB 3.0(super speed)，传输速率最大5Gbps。
- USB 2.0 被设计成为向下兼容的模式，当有全速（USB 1.1）或者低速（USB 1.0）设备连接到高速（USB 2.0）主机时，主机可以通过分离传输来支持它们。
- 一条USB 总线上，可达到的最高传输速度等级由该总线上最慢的“设备”决定。

### 2，USB架构组成

USB 体系包括 ***USB host（主机）*** 、***USB device(设备)*** 以及 ***物理连接(USB interconnect)*** 三个部分。其中，***设备(USB device)*** 又分为 ***USB function*** 和 ***USB Hub***。

#### USB Host

- ***USB host：*** 任何USB系统中只有一个主机。 主机系统的USB接口被称为主机控制器。 主机控制器可以以硬件，固件或软件的组合来实现。 根集线器集成在主机系统内以提供一个或多个连接点。



#### USB device

- USB Hub： USB HUB提供了一种低成本、低复杂度的USB接口扩展方法。HUB的上行PORT面向HOST，下行PORT面向设备(HUB或功能设备)。在下行PORT上，HUB提供了设备连接检测和设备移除检测的能力，并给各下行PORT供电。HUB可以单独使能各下行PORT。不同PORT可以工作在不同的速度等级(高速/全速/低速)。

> （1）一个 USB HOST 最多可以同时支持128 个地址，地址0 作为默认地址，只在设备枚举期间临时使用，而不能被分配给任何一个设备，因此一个USB HOST 最多可以同时支持127 个地址，如果一个设备只占用一个地址，那么可最多支持127 个USB 设备。在实际的USB 体系中，如果要连接127 个USB设备，必须要使用USB HUB，而USB HUB 也是需要占用地址的，所以实际可支持的USB 功能设备的数量将小于127。
> （2）ROOT HUB 是一个特殊的USB HUB，它集成在主机控制器里，不占用地址。ROOT HUB 不但实现了普通USB HUB 的功能，还包括其他一些功能。
> （3）“复合设备（Compound Device）”可以占用多个地址。所谓复合设备其实就是把多个功能设备通过内置的USB HUB 组合而成的设备，比如带录音话筒的USB 摄像头等。

- ***USB function：*** 能够通过总线传输或接收数据或控制信息的设备，在USB2.0标准中，别成为Class，规范中有详细的章节进行定义。主要有以下三类：
  - A human interface device such as a mouse, keyboard, tablet, or game controller
  - An imaging device such as a scanner, printer, or camera
  - A mass storage device such as a CD-ROM drive, floppy drive, or DVD drive
    

#### ***USB interconnect：***

 USB设备连接到主机并与之通信的方式。主要由以下三部分：

- Bus Topology： 

1. USB上的设备通过分层的星形拓扑物理连接到主机，如下图所示。 

2. USB连接点由称为集线器的特殊类别的USB设备提供。

3.  集线器提供的附加连接点称为端口。 主机包括称为根集线器的嵌入式集线器。 

4. 主机通过根集线器提供一个或多个连接点。 

5. 为主机提供附加功能的USB设备称为功能(funcation)。 

6. 为了防止循环附件，USB层的星形拓扑结构上采用了分层排序。

   

   

USB设备和主机之间的连接模型

![](resource/usb/1.png)

> 以HOST-ROOT HUB为起点，最多支持7 层（Tier），也就是说任何一个
> USB 系统中最多可以允许5个USB HUB 级联。一个复合设备（Compound Device）将同时占据两层或更多的层。



- ***Inter-layer Relationships：*** 就功能堆栈而言，是系统中每层执行的USB任务。
- ***Data Flow Models：*** 数据在生产者和消费者之间通过USB在系统中移动的方式。



> 管道（Pipe）是主机和设备端点之间数据传输的模型，共有两种类型的管道：***无格式的流管道（Stream Pipe）***和***有格式的信息管道（Message Pipe）***。任何USB 设备一旦上电就存在一个信息管道，即默认的控制管道，USB 主机通过该管道来获取设备的描述、配置、状态，并对设备进行配置。



***USB Schedule：*** USB 提供共享互连。 为了支持同步数据传输并消除仲裁开销，计划访问互连。



### 3,***NRZI(非归零编码)*** 

NRZ-I编码中，编码后电平只有正负电平之分，没有零电平，是不归零编码。

根据这一编码原则，假设发送端传送8位数据流0000   0001B，前面的7个0位经过NRZ-I编码后，将得到7次翻转信号，如图二的同步域部分。在接收端根据脉宽很容易得到同步接收时钟。此后根据这个频率的倍频来采样后面的数据。在传输过程中，每一次编码的跳变都可以用来同步。这种同步机制在USB低速和中速传输中得到应用。即发送数据前，首先发送同步头**SYNC**，内容为01H。这样就可以[同步传输](https://baike.baidu.com/item/同步传输/2007281)数据了，且字节开头和结尾不需要起始位和停止位。

#### 示例

![](resource/usb/2.jpg)

[NRZ-I](https://baike.baidu.com/item/NRZ-I)电平的一次翻转来表示Data电平的逻辑0，与前一个NRZ-I电平相同的电平表示Data电平的逻辑1（）。仔细观察，我们发现，NRZ-I编码信号经过反向后，还原的内容不变。典型应用如USB传输。

#### 原理

**NRZ-INo Return Zero-Inverse 非归零反相编码**

在传输中，同步头SYNC为00 01H，15个翻转信号。

但是当传输连续的逻辑1位时，NRZ-I编码后，将保持上一次翻转后的状态。这使得接收端无法从中得到同步信号。为此，USB协议规定：如果要发送的数据中出现有连续的6个1，则在进行NRZI编码前，在这6个连续的1后面会插入1个0，然后再进行NRZI编码。接收端收到连续6个1，将自动去掉后面的1个0。从而恢复原数据。如图二的包[数据传送](https://baike.baidu.com/item/数据传送)多个1的处理。这样就使得USB通信的接收同步更加可靠。

解释翻转含义：

这个翻转是在原来的电平上翻转的，当碰到0电平来临的时候，原来的1电平变为现在的0电平。是在上一个电平的基础上翻转的，这样有助于理解。

#### usb中使用NRZI



USB采用不归零取反来传输数据，当传输线上的差分数据输入0时就取反，输入1时就保持原值，为了确保信号发送的准确性，当在USB总线上发送一个包时，传输设备就要进行位插入操作(即在数据流中每连续 6 个 1 后就插入一个0) ，从而强迫 NRZI 码发生变化。接收方解码 NRZI 码流，然后识别出填充位，并丢弃它们。这些是**由专门硬件处理**的。


![](resource/usb/3.png)





### USB数据格式

USB 数据是由二进制数字串构成的，首先 ***数字串组成域（有七种）*** ， ***域再组成包*** ， ***包再组成事务（IN、OUT、SETUP）*** ，***事务最后组成传输（中断传输、并行传输、批量传输和控制传输）*** 

下面介绍一下域、包和事务

**USB协议规定了四种传输（transfer）类型：批量传输、同步传输、中断传输和控制传输**。其中，批量传输、同步传输和中断传输每传输一次数据都是一个事务，控制传输包括三个过程，建立过程和状态过程分别是一个事务，数据过程则可能包含多个事务。
首先介绍几个关键字：



## 参考链接

1. [USB 之一 USB2.0 规范详解 第一部分](https://blog.csdn.net/ZCShouCSDN/article/details/79957404)