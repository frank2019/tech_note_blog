



# H264基本入门



## H.264 是什么

H.264，同时也是[MPEG-4](https://baike.baidu.com/item/MPEG-4)第十部分，是由ITU-T视频编码专家组（VCEG）和ISO/IEC[动态图像专家组](https://baike.baidu.com/item/动态图像专家组/1400570)（MPEG）联合组成的联合视频组（JVT，Joint Video Team）提出的高度压缩数字[视频编解码器](https://baike.baidu.com/item/视频编解码器)标准。这个标准通常被称之为H.264/AVC（或者AVC/H.264或者H.264/MPEG-4 AVC或MPEG-4/H.264 AVC）而明确的说明它两方面的开发者。

### 是谁制定的？

国际上制定视频编解码技术的组织有两个，一个是“[国际电联](https://baike.baidu.com/item/国际电联)（ITU-T）”，它[制定](https://baike.baidu.com/item/制定)的标准有H.261、H.263、H.263+等，另一个是“国际标准化组织（ISO）”它制定的标准有[MPEG-1](https://baike.baidu.com/item/MPEG-1)、[MPEG-2](https://baike.baidu.com/item/MPEG-2)、[MPEG-4](https://baike.baidu.com/item/MPEG-4)等。而H.264则是由两个组织联合组建的联合视频组（JVT）共同制定的新数字[视频编码标准](https://baike.baidu.com/item/视频编码标准)，所以它既是ITU-T的H.264，又是ISO/IEC的MPEG-4高级[视频编码](https://baike.baidu.com/item/视频编码)（Advanced Video Coding，AVC）的第10 部分。因此，不论是MPEG-4 AVC、MPEG-4 Part 10，还是ISO/IEC 14496-10，都是指H.264。



### 什么时候制定的

1998年1月份标准开始草案征集，1999年9月，完成第一个草案，2001年5月制定了其测试模式TML-8，2002年6月的  JVT第5次会议通过了H.264的FCD板。2003年3月正式发布。在2005年又开发出了H.264的更高级应用标准MVC 和 SVC 版本。

国际电联ITU和MPEG组织在发布了H.264标准之后，很快就发布公告，为下一代视频编解码标准H.265征集技术方案。为H.265设定的技术性能指标是：压缩效率比H.264提高1倍、且不明显提高编码和解码的计算量。据MPEG组织2009年西安会议的回顾，尚无一个技术提案达到上述指标。



### 下一代标准H.265

H.265是ITU-T VCEG继H.264之后所制定的新的[视频编码](https://baike.baidu.com/item/视频编码/839038)标准。H.265标准围绕着现有的[视频编码标准](https://baike.baidu.com/item/视频编码标准/3201394)H.264，保留原来的某些技术，同时对一些相关的技术加以改进。新技术使用先进的技术用以改善码流、编码质量、延时和[算法复杂度](https://baike.baidu.com/item/算法复杂度/210801)之间的关系，达到最优化设置。具体的研究内容包括：提高压缩效率、提高[鲁棒性](https://baike.baidu.com/item/鲁棒性/832302)和错误恢复能力、减少实时的时延、减少信道获取时间和随机接入时延、降低复杂度等。H.264由于算法优化，可以低于1Mbps的速度实现标清（分辨率在1280P*720以下）数字图像传送；H.265则可以实现利用1~2Mbps的传输速度传送720P（分辨率1280*720）普通高清音视频传送。

2012年8月，爱立信公司推出了首款H.265编解码器，而在仅仅六个月之后，国际电联（ITU）就正式批准通过了HEVC/H.265标准，标准全称为**高效视频编码（High Efficiency Video Coding）**，相较于之前的H.264标准有了相当大的改善。

目前(2019.9) H.264 还是主流

根据CISCO的分析预测到2021年，从2016年到2021年数据视频还是以高清为主，超高清占30%左右。H.264是对应高清的，H.265对应超高清。
HEVC/H.265什么时候能普及开呢？按H.264的发展推H.265,  预计2020到2023年。





H264标准各主要部分有Access Unit delimiter（访问单元分割符），SEI（附加增强信息），primary coded 
picture（基本图像编码），Redundant Coded Picture（冗余图像编码）。还有Instantaneous Decoding
Refresh（IDR，即时解码刷新）、Hypothetical Reference 
Decoder（HRD，假想参考解码）、Hypothetical Stream Scheduler（HSS，假想码流调度器）。



### H.264目标

H.264是在MPEG-4技术的基础之上建立起来的，其编解码流程主要包括5个部分：帧间和[帧内预测](https://baike.baidu.com/item/帧内预测)（Estimation）、变换（Transform）和反变换、量化（Quantization）和反量化、环路滤波（Loop Filter）、[熵编码](https://baike.baidu.com/item/熵编码)（Entropy Coding）。

H.264标准的主要目标是：与其它现有的视频编码标准相比，在相同的带宽下提供更加优秀的图象质量。通过该标准，在同等图象质量下的压缩效率比以前的标准（MPEG2）提高了2倍左右。

H.264可以提供11个等级、7个类别的子协议格式（[算法](https://baike.baidu.com/item/算法)），其中等级定义是对外部环境进行限定，例如带宽需求、内存需求、网络性能等等。等级越高，带宽要求就越高，[视频质量](https://baike.baidu.com/item/视频质量)也越高。类别定义则是针对特定应用，定义编码器所使用的特性子集，并规范不同应用环境中的编码器复杂程度。



## H264概述

![](img/1.png)

H264压缩技术主要采用了以下几种方法对视频数据进行压缩。包括：

- 帧内预测压缩，解决的是空域数据冗余问题。
- 帧间预测压缩（运动估计与补偿），解决的是时域数据冗徐问题。
- 整数离散余弦变换（DCT），将空间上的相关性变为频域上无关的数据然后进行量化。
- CABAC压缩。

经过压缩后的帧分为：I帧，P帧和B帧:

- I帧：关键帧，采用帧内压缩技术。
- P帧：向前参考帧，在压缩时，只参考前面已经处理的帧。采用帧音压缩技术。
- B帧：双向参考帧，在压缩时，它即参考前而的帧，又参考它后面的帧。采用帧间压缩技术。

除了I/P/B帧外，还有图像序列GOP。

- GOP:两个I帧之间是一个图像序列，在一个图像序列中只有一个I帧。如下图所示：

![](img/2.png)



## H264压缩技术

H264的基本原理其实非常简单，下我们就简单的描述一下H264压缩数据的过程。通过摄像头采集到的视频帧（按每秒 30 帧算），被送到 H264 编码器的缓冲区中。编码器先要为每一幅图片划分宏块。

以下面这张图为例:

![](img/3.jpeg)



### 划分宏块

H264默认是使用 16X16 大小的区域作为一个宏块，也可以划分成 8X8 大小。

![](img/4.jpeg)



划分好宏块后，计算宏块的象素值。

![](img/5.jpeg)



以此类推，计算一幅图像中每个宏块的像素值，所有宏块都处理完后如下面的样子。

![](img/6.jpeg)



### 划分子块

H264对比较平坦的图像使用 16X16 大小的宏块。但为了更高的压缩率，还可以在 16X16 的宏块上更划分出更小的子块。子块的大小可以是 8X16､ 16X8､ 8X8､ 4X8､ 8X4､ 4X4非常的灵活。

![](img/7.jpeg)

上幅图中，红框内的 16X16 宏块中大部分是蓝色背景，而三只鹰的部分图像被划在了该宏块内，为了更好的处理三只鹰的部分图像，H264就在 16X16 的宏块内又划分出了多个子块。

![](img/8.jpeg)

这样再经过帧内压缩，可以得到更高效的数据。下图是分别使用mpeg-2和H264对上面宏块进行压缩后的结果。其中左半部分为MPEG-2子块划分后压缩的结果，右半部分为H264的子块划压缩后的结果，可以看出H264的划分方法更具优势。

![](img/9.jpeg)



宏块划分好后，就可以对H264编码器缓存中的所有图片进行分组了。

### 帧分组

对于视频数据主要有两类数据冗余，一类是时间上的数据冗余，另一类是空间上的数据冗余。其中时间上的数据冗余是最大的。下面我们就先来说说视频数据时间上的冗余问题。

为什么说时间上的冗余是最大的呢？假设摄像头每秒抓取30帧，这30帧的数据大部分情况下都是相关联的。也有可能不止30帧的的数据，可能几十帧，上百帧的数据都是关联特别密切的。

对于这些关联特别密切的帧，其实我们只需要保存一帧的数据，其它帧都可以通过这一帧再按某种规则预测出来，所以说视频数据在时间上的冗余是最多的。

为了达到相关帧通过预测的方法来压缩数据，就需要将视频帧进行分组。那么如何判定某些帧关系密切，可以划为一组呢？我们来看一下例子，下面是捕获的一组运动的台球的视频帧，台球从右上角滚到了左下角。



![](img/10.jpeg)



![](img/11.jpeg)



H264编码器会按顺序，每次取出两幅相邻的帧进行宏块比较，计算两帧的相似度。如下图：

![](img/12.jpeg)

通过宏块扫描与宏块搜索可以发现这两个帧的关联度是非常高的。进而发现这一组帧的关联度都是非常高的。因此，上面这几帧就可以划分为一组。**其算法是：在相邻几幅图像画面中，一般有差别的像素只有10%以内的点,亮度差值变化不超过2%，而色度差值的变化只有1%以内，我们认为这样的图可以分到一组。**

在这样一组帧中，经过编码后，我们只保留第一帖的完整数据，其它帧都通过参考上一帧计算出来。我们称第一帧为**IDR／I帧**，其它帧我们称为**P／B帧**，这样编码后的数据帧组我们称为**GOP**。

### 运动估计与补偿

在H264编码器中将帧分组后，就要计算帧组内物体的运动矢量了。还以上面运动的台球视频帧为例，我们来看一下它是如何计算运动矢量的。

H264编码器首先按顺序从缓冲区头部取出两帧视频数据，然后进行宏块扫描。当发现其中一幅图片中有物体时，就在另一幅图的邻近位置（搜索窗口中）进行搜索。如果此时在另一幅图中找到该物体，那么就可以计算出物体的运动矢量了。下面这幅图就是搜索后的台球移动的位置。

![](img/13.jpeg)

通过上图中台球位置相差，就可以计算出台图运行的方向和距离。H264依次把每一帧中球移动的距离和方向都记录下来就成了下面的样子。

![](img/14.jpeg)

运动矢量计算出来后，将相同部分（也就是绿色部分）减去，就得到了补偿数据。我们最终只需要将补偿数据进行压缩保存，以后在解码时就可以恢复原图了。压缩补偿后的数据只需要记录很少的一点数据。如下所示：

![](img/15.jpeg)



我们把运动矢量与补偿称为**帧间压缩技术**，它解决的是视频帧在时间上的数据冗余。除了帧间压缩，帧内也要进行数据压缩，帧内数据压缩解决的是空间上的数据冗余。下面我们就来介绍一下帧内压缩技术。

### 帧内预测

人眼对图象都有一个识别度，对低频的亮度很敏感，对高频的亮度不太敏感。所以基于一些研究，可以将一幅图像中人眼不敏感的数据去除掉。这样就提出了帧内预测技术。

H264的帧内压缩与JPEG很相似。一幅图像被划分好宏块后，对每个宏块可以进行 9 种模式的预测。找出与原图最接近的一种预测模式。

![](img/16.jpeg)

下面这幅图是对整幅图中的每个宏块进行预测的过程。

![](img/17.jpeg)

帧内预测后的图像与原始图像的对比如下：

![](img/18.jpeg)



然后，将原始图像与帧内预测后的图像相减得残差值。

![](img/19.jpeg)



再将我们之前得到的预测模式信息一起保存起来，这样我们就可以在解码时恢复原图了。效果如下：

![](img/20.jpeg)



经过帧内与帧间的压缩后，虽然数据有大幅减少，但还有优化的空间。

### 对残差数据做DCT

可以将残差数据做整数离散余弦变换，去掉数据的相关性，进一步压缩数据。如下图所示，左侧为原数据的宏块，右侧为计算出的残差数据的宏块。

![](img/21.jpeg)

将残差数据宏块数字化后如下图所示：

![](img/22.jpeg)

将残差数据宏块进行 DCT 转换。

![](img/23.jpeg)

去掉相关联的数据后，我们可以看出数据被进一步压缩了。

![](img/24.jpeg)

做完 DCT 后，还不够，还要进行 CABAC 进行无损压缩。

### CABAC

上面的帧内压缩是属于有损压缩技术。也就是说图像被压缩后，无法完全复原。而CABAC属于无损压缩技术。

无损压缩技术大家最熟悉的可能就是哈夫曼编码了，给高频的词一个短码，给低频词一个长码从而达到数据压缩的目的。MPEG-2中使用的VLC就是这种算法，我们以 A-Z 作为例子，A属于高频数据，Z属于低频数据。看看它是如何做的。

![](img/25.jpeg)

CABAC也是给高频数据短码，给低频数据长码。同时还会根据上下文相关性进行压缩，这种方式又比VLC高效很多。其效果如下：





![](img/26.jpeg)



现在将 A-Z 换成视频帧，它就成了下面的样子。

![](img/27.jpeg)

从上面这张图中明显可以看出采用 CACBA 的无损压缩方案要比 VLC 高效的多。

## 小结

至此，我们就将H264的编码原理讲完了。本篇文章主要讲了以下以点内容：

1. 简音介绍了H264中的一些基本概念。如I/P/B帧， GOP。
2. 详细讲解了H264编码的基本原理，包括：

- 宏块的划分
- 图像分组
- 帧内压缩技术原理
- 帧间压缩技术原理。
- DCT
- CABAC压缩原理。





## 参考链接

1. [H264基本原理](https://www.jianshu.com/p/97b4dc8c7f00)
2. [从零了解H264结构](https://blog.csdn.net/andywang201001/article/details/80274886)

