



### 相机 HAL3

------

Android 的相机硬件抽象层 (HAL) 可将 android.hardware.camera2 中较高级别的相机框架 API  连接到底层的相机驱动程序和硬件。Android 8.0 引入了 Treble，用于将 CameraHal API 切换到由 HAL  接口描述语言 (HIDL) 定义的稳定接口。如果您之前为旧版 Android 开发过相机 HAL  模块和驱动程序，请注意相机管道中发生的重大变化。

**相机 HAL3 功能**
 重新设计 Android Camera API 的目的在于大幅提高应用对于 Android 设备上的相机子系统的控制能力，同时重新组织  API，提高其效率和可维护性。借助额外的控制能力，您可以更轻松地在 Android  设备上构建高品质的相机应用，这些应用可在多种产品上稳定运行，同时仍会尽可能使用设备专用算法来最大限度地提升质量和性能。

版本 3  相机子系统将多个运行模式整合为一个统一的视图，您可以使用这种视图实现之前的任何模式以及一些其他模式，例如连拍模式。这样一来，便可以提高用户对聚焦、曝光以及更多后期处理（例如降噪、对比度和锐化）效果的控制能力。此外，这种简化的视图还能够使应用开发者更轻松地使用相机的各种功能。

API 将相机子系统塑造为一个管道，该管道可按照 1:1  的基准将传入的帧捕获请求转化为帧。这些请求会封装有关帧的捕获和处理的所有配置信息，其中包括分辨率和像素格式；手动传感器、镜头和闪光灯控件；3A  运行模式；RAW->YUV 处理控件；统计信息生成等等。

简单来说，应用框架从相机子系统请求帧，然后相机子系统将结果返回到输出流。此外，系统还会针对每组结果生成包含色彩空间和镜头阴影等信息的元数据。您可以将相机版本  3 看作相机版本 1 的单向流管道。它会将每个捕获请求转化为传感器捕获的一张图像，这张图像将被处理成：

- 包含有关捕获的元数据的结果对象。
- 图像数据的 1 到 N 个缓冲区，每个缓冲区会进入自己的目的地 Surface。

可能的输出 Surface 组经过预配置：

- 每个 Surface 都是一个固定分辨率的图像缓冲区流的目标位置。
- 一次只能将少量 Surface 配置为输出（约 3 个）。

一个请求中包含所需的全部捕获设置，以及要针对该请求将图像缓冲区（从总配置组）推送到其中的输出 Surface  的列表。请求可以只发生一次（使用 capture()），也可以无限重复（使用  setRepeatingRequest()）。捕获的优先级高于重复请求的优先级。

![](res/2-1.png)







## 参考链接

1. [Android [Camera 源码] 相机 HAL3(Camera3) Google官方文档（二）](https://blog.csdn.net/kiazhu/article/details/84788157)
2. [Google源码网地址链接：https://source.android.com/devices/camera](https://source.android.com/devices/camera)